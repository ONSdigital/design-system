name: Run macro, script and visual tests
on:
  push:
    branches:
      - main
jobs:
  run-tests-and-deploy:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      ACTIONS_STEP_DEBUG: true
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          lfs: true
      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: "16"
      - name: Install dependencies
        run: yarn install
      - name: Run macro and script tests
        run: yarn test
      - name: Run visual regression tests
        run: yarn test-visual
      - name: Copy reference images
        if: always()
        run: |
          git lfs pull --include="backstop_data/bitmaps_reference/**/*"
          mkdir -p backstop_data/bitmaps_reference backstop_data/bitmaps_test
          cp -r backstop_data/bitmaps_reference backstop_data/bitmaps_test backstop_data/html_report
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.2.0
        if: success()
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
          branch: none
          folder: backstop_data
          clean: true
          cname: ${{ env.CNAME }}
          commit-message: Deployed from ${{ github.sha }}
          enable-jekyll: false
          root-dir: backstop_data/html_report
      - name: Notify Slack
        if: always()
        uses: edgium/simple-slack-notify@master
        with:
          channel: "#pat-lib-notifications"
          status: ${{ job.status }}
          success_text: "The build completed successfully"
          failure_text: "The build failed"
          cancelled_text: "The build was cancelled"
          fields: |
            [
              {
                "title": "Action",
                "value": "${{ github.workflow }} - build (${GITHUB_RUN_NUMBER})",
                "short": true
              },
              {
                "title": "Repository",
                "value": "${{ github.repository }}",
                "short": true
              },
              {
                "title": "By",
                "value": "${{ github.actor }}",
                "short": true
              },
              {
                "title": "Branch",
                "value": "${{ github.head_ref }}",
                "short": true
              },
              {
                "title": "View job",
                "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            ]
