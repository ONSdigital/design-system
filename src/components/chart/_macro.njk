{% from "components/list/_macro.njk" import onsList %}

{% macro onsChart(params) %}
    {% set supportedChartTypes = ['line', 'bar', 'column', 'scatter', 'area', 'columnrange', 'boxplot'] %}
    {% set supportedChartTypesWithLine = ['column', 'columnrange'] %}
    {% set supportedChartTypesWithScatter = ['columnrange'] %}

    {% if params.headingLevel and params.headingLevel >= 1 and params.headingLevel <= 4 %}
        {% set headingLevel = params.headingLevel %}
    {% else %}
        {% set headingLevel = 2 %}
    {% endif %}
    {% if params.featured %}
        {% set openingArticleTitleTag = "<h" ~ headingLevel %}
        {% set closingArticleTitleTag = "</h" ~ headingLevel ~ ">" %}
        {% set openingTitleTag = "<h" ~ (headingLevel + 1) %}
        {% set closingTitleTag = "</h" ~ (headingLevel + 1) ~ ">" %}
        {% set openingSubtitleTag = "<h" ~  (headingLevel + 2) %}
        {% set closingSubtitleTag = "</h" ~ (headingLevel + 2) ~ ">" %}
        {% set openingDownloadTitleTag = "<h" ~ (headingLevel + 3) %}
        {% set closingDownloadTitleTag = "</h" ~ (headingLevel + 3) ~ ">" %}
    {% else %}
        {% set openingTitleTag = "<h" ~ headingLevel %}
        {% set closingTitleTag = "</h" ~ headingLevel ~ ">" %}
        {% set openingSubtitleTag = "<h" ~  (headingLevel + 1) %}
        {% set closingSubtitleTag = "</h" ~ (headingLevel + 1) ~ ">" %}
        {% set openingDownloadTitleTag = "<h" ~ (headingLevel + 2) %}
        {% set closingDownloadTitleTag = "</h" ~ (headingLevel + 2) ~ ">" %}
    {% endif %}

    <div
        data-highcharts-base-chart
        data-highcharts-type="{{ params.chartType }}"
        data-highcharts-theme="{{ params.theme }}"
        data-highcharts-title="{{ params.title }}"
        data-highcharts-id="{{ params.id }}"
        {% if params.featured %}
            class="ons-chart--featured"
        {% endif %}
        {% if params.useStackedLayout %}data-highcharts-use-stacked-layout="{{ params.useStackedLayout }}"{% endif %}
        {% if params.percentageHeightDesktop and params.chartType != 'bar' %}
            data-highcharts-percentage-height-desktop="{{ params.percentageHeightDesktop }}"
        {% endif %}
        {% if params.percentageHeightMobile and params.chartType != 'bar' %}
            data-highcharts-percentage-height-mobile="{{ params.percentageHeightMobile }}"
        {% endif %}
        {% if params.xAxis.tickIntervalMobile %}
            data-highcharts-x-axis-tick-interval-mobile="{{ params.xAxis.tickIntervalMobile }}"
        {% endif %}
        {% if params.xAxis.tickIntervalDesktop %}
            data-highcharts-x-axis-tick-interval-desktop="{{ params.xAxis.tickIntervalDesktop }}"
        {% endif %}
        {% if params.yAxis.tickIntervalMobile %}
            data-highcharts-y-axis-tick-interval-mobile="{{ params.yAxis.tickIntervalMobile }}"
        {% endif %}
        {% if params.yAxis.tickIntervalDesktop %}
            data-highcharts-y-axis-tick-interval-desktop="{{ params.yAxis.tickIntervalDesktop }}"
        {% endif %}
        {% if params.estimateLineLabel %}
            data-highcharts-estimate-line-label="{{ params.estimateLineLabel }}"
        {% endif %}
        {% if params.uncertaintyRangeLabel %}
            data-highcharts-uncertainty-range-label="{{ params.uncertaintyRangeLabel }}"
        {% endif %}
    >
        <figure class="ons-chart">
            {% if params.featured %}
                {{ openingArticleTitleTag | safe }}
                class="ons-chart__item-title ons-u-fs-m ons-u-mt-no ons-u-mb-2xs">
                <a href="{{ params.articleTitle.url }}">{{ params.articleTitle.text }}</a>
                {{ closingArticleTitleTag | safe }}
                {%- if params.metadata -%}
                    <ul class="ons-chart__item-metadata">
                        {%- if params.metadata.date -%}
                            <li class="ons-chart__item-attribute">
                                {% set prefixClass = "ons-u-fw-b" if params.metadata.date.showPrefix == true else "ons-u-vh" %}
                                <span class="{{ prefixClass }}">{{ params.metadata.date.prefix | default("Published") }}: </span>
                                {%- if params.metadata.date.iso -%}
                                    <time datetime="{{ params.metadata.date.iso }}">{{ params.metadata.date.short }}</time>
                                {%- endif -%}
                            </li>
                        {% endif %}

                        {%- if params.metadata.object and params.metadata.object.text -%}
                            <li class="ons-chart__item-attribute{{ ' ons-u-mr-no' if params.metadata.file }}">
                                {% set metadataObject %}
                                    <span {% if not params.metadata.file and not params.metadata.object.url %}class="ons-u-fw-b"{% endif %}
                                        >{{ params.metadata.object.text }}{%- if params.metadata.object.ref -%}:{% elif params.metadata.file %},{% endif %}</span
                                    >
                                {% endset %}
                                {%- if params.metadata.object.url -%}
                                    <a class="ons-chart__attribute-link" href="{{ params.metadata.object.url }}">
                                        {{ metadataObject | safe }}
                                    </a>
                                {% else %}
                                    {{ metadataObject | safe }}
                                {% endif %}
                                {%- if params.metadata.object.ref -%}
                                    <span>{{ params.metadata.object.ref }}</span>
                                {% endif %}
                            </li>
                        {% endif %}

                        {%- if params.metadata.file and params.metadata.file.fileType -%}
                            <li class="ons-chart__item-attribute" aria-hidden="true">
                                {%
                                    set fileMetadataItems = [
                                    params.metadata.file.fileType if params.metadata.file.fileType,
                                    params.metadata.file.fileSize if params.metadata.file.fileSize,
                                    params.metadata.file.filePages if params.metadata.file.filePages ]
                                %}
                                {{ fileMetadataItems | join(', ') }}
                            </li>
                        {%- endif -%}
                    </ul>
                {% endif %}
            {% endif %}

            {{ openingTitleTag | safe }}
            class="ons-chart__title">{{ params.title }}{{ closingTitleTag | safe }}
            {{ openingSubtitleTag | safe }}
            class="ons-chart__subtitle">{{ params.subtitle }}{{ closingSubtitleTag | safe }}
            {% if params.description %}
                <p class="ons-u-vh">{{ params.description }}</p>
            {% endif %}
            {% if params.chartType == 'boxplot' and (params.estimateLineLabel or params.uncertaintyRangeLabel) and params.legend == true %}
                <div class="ons-chart__boxplot-legend">
                    {% if params.uncertaintyRangeLabel %}
                        <div class="ons-chart__boxplot-legend-item">
                            <span class="ons-chart__boxplot-legend-item ons-chart__boxplot-legend-item--uncertainty"></span>
                            <span class="ons-chart__boxplot-legend-label">{{ params.uncertaintyRangeLabel }}</span>
                        </div>
                    {% endif %}
                    {% if params.estimateLineLabel %}
                        <div class="ons-chart__boxplot-legend-item">
                            <span class="ons-chart__boxplot-legend-item ons-chart__boxplot-legend-item--estimate"></span>
                            <span class="ons-chart__boxplot-legend-label">{{ params.estimateLineLabel }}</span>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            {% if params.chartType in supportedChartTypes %}
                <div data-highcharts-chart></div>
            {% else %}
                <p data-invalid-chart-type><b>Chart type "{{ params.chartType }}" is not supported</b></p>
            {% endif %}
            {#
                Footnotes for the annotations at mobile
                Hidden from screen readers because the full text will be read out where they appear in the chart
            #}
            <ul class="ons-chart__footnotes" aria-hidden="true">
                {% for annotation in params.annotations %}
                    <li class="ons-chart__footnote_item">
                        <span class="ons-chart__footnote-number">{{ loop.index }}</span>
                        {{ annotation.text }}
                    </li>
                {% endfor %}
                {% for rangeAnnotation in params.rangeAnnotations %}
                    <li class="ons-chart__footnote_item">
                        <span class="ons-chart__footnote-number">{{ loop.index + params.annotations | length }}</span>
                        {{ rangeAnnotation.text }}
                    </li>
                {% endfor %}
                {% for referenceLineAnnotation in params.referenceLineAnnotations %}
                    <li class="ons-chart__footnote_item">
                        <span class="ons-chart__footnote-number"
                            >{{ loop.index + params.annotations | length + params.rangeAnnotations | length }}</span
                        >
                        {{ referenceLineAnnotation.text }}
                    </li>
                {% endfor %}
            </ul>
            {% if params.caption %}
                <figcaption class="ons-chart__caption">{{ params.caption }}</figcaption>
            {% endif %}
        </figure>

        {% if params.featured and params.itemsList %}
            <div class="ons-chart__items-list">
                {{
                    onsList({
                        "element": "ul",
                        "itemsList": params.itemsList
                    })
                }}
            </div>
        {% endif %}

        {% if params.download.title and params.download.itemsList | length > 0 %}
            {{ openingDownloadTitleTag | safe }}
            class="ons-chart__download-title">{{ params.download.title }}{{ closingDownloadTitleTag | safe }}
            {{
                onsList({
                    "element": "ol",
                    "itemsList": params.download.itemsList
                })
            }}
        {% endif %}
        {% if params.chartType in supportedChartTypes %}
        {% set series = [] %}
        {% set lineSeriesCount = 0 %}
        {% for item in params.series %}
            {% if item.type == 'line' and lineSeriesCount > 0 %}
                {# skip extra line series as the DS guidelines only allow for one extra line series #}
            {% else %}
                {%
                    set seriesItem = {
                        "name": item.name if item.name else '',
                        "data": item.data if item.data else [],
                        "marker": {
                            "enabled": item.marker if item.marker else false
                        },
                        "dataLabels": {
                            "enabled": item.dataLabels if item.dataLabels else false
                        },
                        "connectNulls": item.connectNulls if item.connectNulls else false,
                        "type": item.type if item.type and (item.type == 'line' and params.chartType in supportedChartTypesWithLine) or (item.type == 'scatter' and params.chartType in supportedChartTypesWithScatter) else params.chartType
                    }
                %}
                {# Use `set` tag to avoid printing the return value of extend #}
                {% set _ = extend(series, seriesItem) %}
            {% endif %}
            {% if item.type == 'line' %}
                {% set lineSeriesCount = lineSeriesCount + 1 %}
            {% endif %}
        {% endfor %}
        {# Set the legend value to true by default #}
        {% set legendValue = true %}
        {% if params.legend is defined %}
            {# if a legend parameter has been provided, check that it is a boolean #}
            {% if params.legend == true or params.legend == false %}
                {# legend value is a boolean - use the value passed in #}
                {% set legendValue = params.legend %}
            {% endif %}
        {% endif %}
        {%
            set config = {
                "chart": {
                    "type": params.chartType,
                    "inverted": params.isChartInverted if params.isChartInverted == true else false
                },
                "legend": {
                    "enabled" : legendValue
                },
                "yAxis": {
                    "title": {
                        "text": params.yAxis.title
                    },
                    "labels": {
                        "format": params.yAxis.labelFormat
                    }
                },
                "xAxis": {
                    "title": {
                        "text": params.xAxis.title
                    },
                    "categories": params.xAxis.categories,
                    "type": params.xAxis.type,
                    "labels": {
                        "format": params.xAxis.labelFormat
                    }
                },
                "series": series
            }
        %}

        <!-- Set scripts to pass the config values as json to the javascript -->
        <!-- prettier-ignore-start -->
            <script type="application/json" data-highcharts-config--{{ params.id }}>
                {{ config | tojson }}
            </script>
        {% endif %}
        {% if params.annotations %}
            <script type="application/json" data-highcharts-annotations--{{ params.id }}>
                {{ params.annotations | tojson }}
            </script>
        {% endif %}
        {% if params.rangeAnnotations %}
            <script type="application/json" data-highcharts-range-annotations--{{ params.id }}>
                {{ params.rangeAnnotations | tojson }}
            </script>
        {% endif %}
        {% if params.referenceLineAnnotations %}
            <script type="application/json" data-highcharts-reference-line-annotations--{{ params.id }}>
                {{ params.referenceLineAnnotations | tojson }}
            </script>
        {% endif %}
        <!-- prettier-ignore-end -->
    </div>
{% endmacro %}
