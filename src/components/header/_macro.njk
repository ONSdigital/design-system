{% macro onsHeader(params) %}
    {% from "components/button/_macro.njk" import onsButton %}
    {% from "components/icons/_macro.njk" import onsIcon %}
    {% from "components/navigation/_macro.njk" import onsNavigation %}

    {% set title_tag = "h1" if params.tilteAsH1 else "div" %}
    {% set currentLanguageISOCode = "en" %}

    {% if params.language is defined and params.language and params.language.languages is defined and params.language.languages %}
        {% set currentLanguage = params.language.languages | selectattr("current") | first %}
        {% set currentLanguageISOCode = currentLanguage.ISOCode %}
    {% endif %}

    <header class="ons-header {% if params.variants is not string %}{% for variant in params.variants %} ons-header--{{ variant }}{% endfor %}{% else %} ons-header--{{ params.variants }}{% endif %}" role="banner">
        {% if params.phase is defined and params.phase %}
            {% from "components/phase-banner/_macro.njk" import onsPhaseBanner %}
            {{ onsPhaseBanner(params.phase) }}
        {% endif %}
        <div class="ons-header__top">
            <div class="ons-container{{ ' ons-container--full-width' if params.fullWidth }}{{ ' ons-container--wide' if params.wide }}">
                <div class="ons-header__grid-top ons-grid ons-grid--gutterless ons-grid--flex ons-grid--between ons-grid--vertical-center ons-grid--no-wrap{{ ' ons-header__grid-top-tall' if params.customHeaderLogo is defined and params.customHeaderLogo }}">
                    <div class="ons-grid__col ons-col-auto">
                        <div class="ons-header__logo--large">
                            {%-if params.logoHref is defined and params.logoHref %}<a class="ons-header__logo-link" href="{{ params.logoHref }}">{% endif -%}
                            {{
                                onsIcon({
                                    "iconType": params.logo | default('ons-logo-' + currentLanguageISOCode),
                                    "altText": params.logoAlt | default('Office for National Statistics logo')
                                })
                            }}
                            {%- if params.logoHref is defined and params.logoHref %}</a>{% endif -%}
                        </div>
                        <div class="ons-header__logo--small">
                            {% if params.logoHref is defined and params.logoHref %}<a class="ons-header__logo-link" href="{{ params.logoHref }}">{% endif %}
                            {{
                                onsIcon({
                                    "iconType": params.mobileLogo | default('ons-logo-stacked-' + currentLanguageISOCode),
                                    "altText": params.logoAlt | default('Office for National Statistics logo')
                                })
                            }}
                            {% if params.logoHref is defined and params.logoHref %}</a>{% endif %}
                        </div>
                    </div>
                    {% if params.language is defined and params.language or params.serviceLinks is defined and params.serviceLinks %}
                        <div class="ons-header__links ons-grid__col ons-col-auto">
                            {% if params.language is defined and params.language %}
                                <div class="ons-grid__col ons-col-auto {{ ' ons-u-mr-s ons-u-d-no@xxs@xs' if params.serviceLinks is defined and params.serviceLinks else '' }}">
                                    {% from "components/language-selector/_macro.njk" import onsLanguageSelector %}
                                    {{ onsLanguageSelector(params.language) }}
                                </div>
                            {% endif %}
                            {% if params.serviceLinks is defined and params.serviceLinks %}
                                {% if params.serviceLinks.itemsList | length == 1 and params.language is defined and params.language %}
                                    {% set breakpoint = 'xs' %}
                                    {% set controlVisibility = true %}
                                {% elif params.serviceLinks.itemsList | length > 1 %}
                                    {% set breakpoint = 'm' %}
                                    {% set controlVisibility = true %}
                                {% else %}
                                    {% set controlVisibility = false %}
                                {% endif %}
                                <div class="ons-grid__col ons-col-auto{% if controlVisibility == true %} ons-u-d-no@xxs@{{ breakpoint }}{% endif %}">
                                    <nav class="ons-header-service-nav ons-header-service-nav--main {{ params.serviceLinks.classes }}" aria-label="{{ params.serviceLinks.ariaLabel | default("Service links navigation") }}">
                                        <ul class="ons-header-service-nav__list" aria-label="{{ params.serviceLinks.ariaListLabel | default("Service Links") }}">
                                            {% for item in (params.serviceLinks.itemsList if params.serviceLinks.itemsList is iterable else params.serviceLinks.itemsList.items()) %}                                                
                                                <li class="ons-header-service-nav__item">
                                                    <a
                                                        href="{{ item.url }}"
                                                        class="ons-header-service-nav__link"
                                                        {% if item.id is defined and item.id %} id="{{ item.id }}"{% endif %}
                                                    >{{ item.title }}</a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </nav>
                                </div>
                                {% if params.serviceLinks.itemsList | length > 1  or params.language is defined and params.language %}
                                    {% if params.variants == 'internal' %}
                                        {% set buttonVariant = ["text-link", "text-link-inverse"] %}
                                    {% else %}
                                        {% set buttonVariant = "text-link" %}
                                    {% endif %}
                                    <div class="ons-grid__col ons-col-auto ons-u-d-no@{{ breakpoint }}">
                                        {{ onsButton({
                                            "text": params.serviceLinks.toggleServicesButton.text | default("Menu"),
                                            "classes": "ons-u-d-no ons-js-toggle-services",
                                            "type": "button",
                                            "buttonStyle": "mobile",
                                            "variants": buttonVariant,
                                            "attributes": {
                                                "aria-label": params.serviceLinks.toggleServicesButton.ariaLabel | default("Toggle menu"),
                                                "aria-controls": params.serviceLinks.id,
                                                "aria-haspopup": "true",
                                                "aria-expanded": "false"
                                            }
                                        }) }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% if params.serviceLinks is defined and params.serviceLinks %}
                <nav class="ons-header-service-nav ons-header-service-nav--mobile ons-u-d-no ons-js-services-mobile-nav" id="{{ params.serviceLinks.id }}" aria-label="{{ params.serviceLinks.ariaLabel | default("Service links navigation") }}">
                    <ul class="ons-header-service-nav__list" aria-label="{{ params.serviceLinks.ariaListLabel | default("Service Links") }}">
                        {% for item in (params.serviceLinks.itemsList if params.serviceLinks.itemsList is iterable else params.serviceLinks.itemsList.items()) %}                                                
                            <li class="ons-header-service-nav__item ons-header-service-nav__item--mobile">
                                <a
                                    href="{{ item.url }}"
                                    class="ons-header-service-nav__link"
                                    {% if item.id is defined and item.id %} id="{{ item.id }}"{% endif %}
                                >{{ item.title }}</a>
                            </li>
                        {% endfor %}
                        {% if params.language is defined and params.language %}
                            <div class="ons-u-d-no@xs">
                                {% from "components/language-selector/_macro.njk" import onsLanguageSelector %}
                                {{ onsLanguageSelector(params.language) }}
                            </div>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
        <div class="ons-header__main">
            <div class="ons-container{{ ' ons-container--full-width' if params.fullWidth }}{{ ' ons-container--wide' if params.wide }}">
                <div class="ons-grid ons-grid--gutterless ons-grid--flex ons-grid--between ons-grid--vertical-center ons-grid--no-wrap">
                    <div class="ons-grid__col ons-col-auto ons-u-flex-shrink{% if params.titleLogo == 'census-logo-en' %} ons-header__title-census-logo-en{% endif %}">
                        {% if params.titleLogoHref is defined and params.titleLogoHref %}<a class="ons-header__title-link" href="{{ params.titleLogoHref }}">{% endif %}
                        {% if params.titleLogo is defined and params.titleLogo and params.titleLogoAlt is defined and params.titleLogoAlt %}
                            {% from "components/icons/_macro.njk" import onsIcon %}
                            {{
                                onsIcon({
                                    "iconType": params.titleLogo,
                                    "altText": params.titleLogoAlt
                                })
                            }}
                        {% else %}
                            <{{ title_tag }} class="ons-header__title">{{ params.title }}</{{ title_tag }}>
                        {% endif %}
                        {% if params.titleLogoHref is defined and params.titleLogoHref %}</a>{% endif %}
                        {% if params.description is defined and params.description %}
                            <p class="ons-header__description">{{ params.description }}</p>
                        {% endif %}
                    </div>
                    {% if params.button is defined and params.button %}
                        <div class="ons-grid__col ons-col-auto ons-u-flex-no-shrink">
                            {{ onsButton({
                                "text": params.button.text,
                                "classes": "ons-u-d-no@xxs@m",
                                "variants": "ghost",
                                "name": params.button.name,
                                "attributes": params.button.attributes,
                                "url": params.button.url,
                                "iconType": params.button.iconType,
                                "iconPosition": params.button.iconPosition
                            }) }}
                        </div>
                    {% endif %}
                    {% if params.navigation is defined %}
                        <div class="ons-grid__col ons-col-auto ons-u-flex-no-shrink ons-u-d-no@l">
                            {% if isPatternLib and params.navigation.siteSearchAutosuggest %}
                                <span class="ons-grid ons-u-d-no@xxs@xs">
                                    {{ onsButton({
                                        "text": "Search",
                                        "classes": "ons-btn--search ons-u-ml-xs ons-u-d-no ons-js-toggle-search",
                                        "variants": ["ghost", "small"],
                                        "iconType": "search",
                                        "iconPosition": "only",
                                        "attributes": {
                                            "aria-label": "Toggle search" ,
                                            "aria-controls": "ons-site-search",
                                            "aria-haspopup": "true",
                                            "aria-expanded": "false"
                                        }
                                    }) }}
                                </span>
                            {% endif %}
                            {% if params.navigation.toggleNavigationButton is defined and params.navigation.toggleNavigationButton %}
                                {{ onsButton({
                                    "text": params.navigation.toggleNavigationButton.text,
                                    "classes": "ons-u-ml-xs ons-u-d-no ons-js-navigation-button",
                                    "buttonStyle": "mobile",
                                    "variants": ["mobile", "ghost"],
                                    "attributes": {
                                        "aria-label": params.navigation.toggleNavigationButton.ariaLabel | default("Toggle main menu") ,
                                        "aria-controls": params.navigation.id,
                                        "aria-haspopup": "true",
                                        "aria-expanded": "false"
                                    }
                                }) }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% if params.navigation is defined and params.navigation %}
            {{ onsNavigation(params.navigation) }}
        {% endif %}
    </header>
{% endmacro %}
